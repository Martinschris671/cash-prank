<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- The final, correct head section -->
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, user-scalable=no"
    />
    <title>Authentication</title>

    <!-- Fonts and Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css"
    />

    <!-- ======================================================= -->
    <!-- == CRITICAL LIBRARIES (FIXES "CryptoJS is not defined") == -->
    <!-- ======================================================= -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js"></script>
    <!-- ======================================================= -->

    <!-- Your existing perfect CSS -->
    <style>
      @font-face {
        font-family: "CashMarket";
        font-style: normal;
        src: url(font/CashSans-Regular.otf);
        font-display: swap;
      }
      :root {
        /* ... your variables ... */
      }
      /* ... all your other CSS ... */
      .auth-container {
        display: none;
      } /* Hide container initially */
    </style>
  </head>
  <body>
    <!-- The auth-container is initially hidden and shown by the script -->
    <div class="auth-container" id="auth-container">
      <header class="auth-header">
        <h1 id="form-title">Create account</h1>
        <p id="form-subtitle">
          Enter your details. Already have an account?
          <a id="mode-toggle">Log in</a>
        </p>
      </header>
      <form id="auth-form" class="auth-form" novalidate>
        <div>
          <div class="account-switch-prompt hidden" id="account-switch-prompt">
            Welcome back.
            <a id="switch-account-link">Use a different account</a>
          </div>
          <div class="input-group" id="email-group">
            <label for="email-input">Email</label>
            <input
              type="email"
              id="email-input"
              class="input-field"
              placeholder="your@email.com"
              autocomplete="email"
            />
          </div>
          <div class="input-group" id="password-group">
            <label for="password-input">Password</label>
            <div class="input-wrapper">
              <input
                type="password"
                id="password-input"
                class="input-field"
                autocomplete="current-password"
              />
              <span id="visibility-toggle" class="visibility-toggle"
                ><i class="fa-regular fa-eye-slash"></i
              ></span>
            </div>
          </div>
          <p id="error-message" class="error-message"></p>
        </div>
        <footer class="auth-footer">
          <button type="submit" id="action-button" class="action-button">
            <span id="button-text">Create Account</span>
            <div id="spinner" class="spinner hidden"></div>
          </button>
          <p class="legal-text">
            By clicking Continue, you agree to the <a href="#">Terms</a>,
            <a href="#">E-Sign Consent</a>, & <a href="#">Privacy Policy</a>.
          </p>
        </footer>
      </form>
    </div>

    <script type="module">
      // --- The Final, Advanced, and Clean Authentication Logic ---

      // Import Firebase functions first
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
      } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";

      // =======================================================
      // == CONFIGURATION AND ELEMENT SETUP ==
      // =======================================================
      const firebaseConfig = {
        /* Your Firebase Config Here */
      };
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      const elements = {
        authContainer: document.getElementById("auth-container"),
        form: document.getElementById("auth-form"),
        title: document.getElementById("form-title"),
        subtitle: document.getElementById("form-subtitle"),
        emailInput: document.getElementById("email-input"),
        passwordInput: document.getElementById("password-input"),
        actionButton: document.getElementById("action-button"),
        buttonText: document.getElementById("button-text"),
        spinner: document.getElementById("spinner"),
        errorMessage: document.getElementById("error-message"),
        visibilityToggle: document.getElementById("visibility-toggle"),
        accountSwitchPrompt: document.getElementById("account-switch-prompt"),
        switchAccountLink: document.getElementById("switch-account-link"),
        modeToggleLink: document.getElementById("mode-toggle"),
      };

      let isLoginMode = false; // Start in "Create Account" mode by default

      // =======================================================
      // == ADVANCED FINGERPRINTING FUNCTION ==
      // =======================================================
      const generateFingerprint = async () => {
        const hash = (data) => CryptoJS.SHA256(data).toString(CryptoJS.enc.Hex);
        const components = {
          /* All fingerprint components here */
        };
        components.userAgent = navigator.userAgent;
        components.language = navigator.language;
        components.screenResolution = `${window.screen.width}x${window.screen.height}`;
        try {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          ctx.fillText("a'!)_`~-^@,;*<:>.?/|&%$#123AbZ", 2, 15);
          components.canvas = hash(canvas.toDataURL());
        } catch (e) {
          components.canvas = "error";
        }
        const fullFingerprintString = JSON.stringify(components);
        return hash(fullFingerprintString);
      };

      // =======================================================
      // == MAIN AUTHENTICATION AND UI LOGIC ==
      // =======================================================

      const setUIMode = (isLogin) => {
        isLoginMode = isLogin;
        elements.errorMessage.textContent = "";
        if (isLogin) {
          elements.title.textContent = "Log in";
          elements.subtitle.innerHTML = "This device already has an account.";
          elements.buttonText.textContent = "Continue";
        } else {
          elements.title.textContent = "Create account";
          elements.subtitle.innerHTML =
            'Already have an account? <a id="mode-toggle" href="#">Log in</a>';
          elements.buttonText.textContent = "Create Account";
          document
            .getElementById("mode-toggle")
            .addEventListener("click", (e) => {
              e.preventDefault();
              setUIMode(true);
            });
        }
      };

      const handleAuth = async (e) => {
        e.preventDefault();
        const email = elements.emailInput.value.trim();
        const password = elements.passwordInput.value;
        elements.errorMessage.textContent = "";
        elements.actionButton.disabled = true;
        elements.buttonText.classList.add("hidden");
        elements.spinner.classList.remove("hidden");

        try {
          if (isLoginMode) {
            await signInWithEmailAndPassword(auth, email, password);
            localStorage.setItem("lastAppUser", email);
            window.location.href = "pay.html";
          } else {
            const fingerprint = await generateFingerprint();
            const response = await fetch("/api/signup", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email: email, fingerprint: fingerprint }),
            });
            const result = await response.json();
            if (!response.ok) {
              throw new Error(result.message);
            }

            await createUserWithEmailAndPassword(auth, email, password);
            const trialEndDate = new Date();
            trialEndDate.setDate(trialEndDate.getDate() + 2);
            localStorage.setItem(
              `sub_${email}`,
              JSON.stringify({
                status: "TRIAL",
                endDate: trialEndDate.toISOString(),
              })
            );
            localStorage.setItem("lastAppUser", email);
            window.location.href = "pay.html";
          }
        } catch (error) {
          elements.actionButton.disabled = false;
          elements.buttonText.classList.remove("hidden");
          elements.spinner.classList.add("hidden");
          let message = "An unexpected error occurred. Please try again.";
          if (error.message.includes("not eligible")) {
            message = "This device already has an account. Please log in.";
          } else if (error.code) {
            switch (error.code) {
              case "auth/user-not-found":
                message = "No account found with this email.";
                break;
              case "auth/wrong-password":
                message = "Incorrect password. Please try again.";
                break;
              case "auth/email-already-in-use":
                message = "This email is already registered. Please log in.";
                break;
              case "auth/weak-password":
                message = "Password must be at least 6 characters.";
                break;
              case "auth/invalid-email":
                message = "Please enter a valid email address.";
                break;
            }
          } else {
            message = error.message;
          }
          elements.errorMessage.textContent = message;
        }
      };

      const initPage = async () => {
        // --- Auto-Redirect Logic for Active Sessions ---
        const currentUserEmail = localStorage.getItem("lastAppUser");
        if (currentUserEmail) {
          const userSubData =
            JSON.parse(localStorage.getItem(`sub_${currentUserEmail}`)) || {};
          const { status, endDate: endDateString } = userSubData;
          if (
            status === "LIFETIME" ||
            (endDateString && new Date(endDateString).getTime() > Date.now())
          ) {
            window.location.replace("pay.html");
            return; // Stop further execution
          }
        }

        // --- Advanced Device Check to Set UI Mode ---
        try {
          const fingerprint = await generateFingerprint();
          // We'll do a "dry run" check by sending the fingerprint to the server
          const response = await fetch("/api/signup", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ fingerprint: fingerprint, checkOnly: true }), // Send a checkOnly flag
          });

          if (!response.ok) {
            // If the server returns a 403 (Forbidden), it means the device is known.
            // Force the page into "Log in" mode permanently for this session.
            setUIMode(true);
          } else {
            // Device is new, allow "Create Account" mode.
            setUIMode(false);
          }
        } catch (error) {
          // If the check fails, default to allowing sign-up but it will be caught by the real submission
          console.error("Device check failed:", error);
          setUIMode(false);
        }

        // Show the container now that the UI is set
        elements.authContainer.style.display = "flex";

        // Attach event listeners
        elements.form.addEventListener("submit", handleAuth);
        elements.visibilityToggle.addEventListener("click", () => {
          const isPassword = elements.passwordInput.type === "password";
          elements.passwordInput.type = isPassword ? "text" : "password";
          elements.visibilityToggle.innerHTML = isPassword
            ? '<i class="fa-regular fa-eye"></i>'
            : '<i class="fa-regular fa-eye-slash"></i>';
        });
      };

      // --- START THE APPLICATION ---
      document.addEventListener("DOMContentLoaded", initPage);
    </script>
  </body>
</html>
