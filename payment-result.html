<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Payment Result - Cash App</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
      integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <script src="guard.js"></script>
    <!-- Anti-Flicker Dark Mode Script -->
    <script>
      (function () {
        let theme =
          window.localStorage.getItem("app-theme-preference") || "system";
        if (theme === "system") {
          theme = window.matchMedia("(prefers-color-scheme: dark)").matches
            ? "dark"
            : "light";
        }
        document.documentElement.setAttribute("data-theme", theme);
      })();
    </script>
    <style>
      @font-face {
        font-family: "CashMarket";
        font-style: normal;
        src: url(font/CashSans-Regular.otf);
        font-display: swap;
      }
      /* --- LIGHT MODE THEME (DEFAULT) --- */
      :root {
        --padding-screen: 24px;
        --app-bg-color: #ffffff;
        --text-primary: #000000;
        --text-secondary: #6c757d;
        --accent-green: #47b349;
        --accent-red: #ff3b30;
        --font-family: "CashMarket", -apple-system, BlinkMacSystemFont,
          sans-serif;
        --menu-bg: #ffffff;
        --menu-border: #e6e6e6;
        --menu-hover: #f8f8f8;
        --menu-divider: #f0f1f2;
        --status-icon: #ffffff;
      }

      /* --- DARK MODE THEME --- */
      [data-theme="dark"] {
        --app-bg-color: #000000;
        --text-primary: #ffffff;
        --text-secondary: #8e8e93;
        --menu-bg: #1c1c1e;
        --menu-border: #3a3a3c;
        --menu-hover: #2c2c2e;
        --menu-divider: #3a3a3c;
        --status-icon: #000;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      html,
      body {
        height: 100%;
      }
      body {
        font-family: var(--font-family);
        background-color: var(--app-bg-color);
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: background-color 0.3s, color 0.3s;
      }
      a {
        text-decoration: none;
        color: inherit;
      }
      .result-container {
        max-width: 450px;
        width: 100%;
        height: 100%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        position: relative;
      }
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px;
        height: 65px;
      }
      .close-btn {
        width: 20px;
        height: 20px;
        cursor: pointer;
        color: var(--text-primary);
      }
      .menu-btn {
        background: none;
        border: none;
        font-size: 20px;
        color: var(--text-secondary);
        cursor: pointer;
        padding: 8px;
        opacity: 0;
      }
      .result-content {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        justify-content: flex-start;
        padding: 0px var(--padding-screen) 0;
      }
      .status-icon {
        width: 54px;
        height: 54px;
        border-radius: 50%;
        display: grid;
        place-items: center;
        margin-bottom: 24px;
        animation: pop-in 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }
      @keyframes pop-in {
        from {
          transform: scale(0.5);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }
      .status-icon i,
      .status-icon svg {
        color: var(--status-icon);
        width: 28px;
        height: 28px;
      }
      .status-icon img {
        width: 32px;
        height: 32px;
        object-fit: contain;
      }
      .status-icon.success {
        background-color: var(--accent-green);
      }
      .status-icon.pending {
        background-color: var(--accent-red);
      }
      .status-icon.received {
        background-color: var(--text-secondary);
      }
      .result-title {
        font-size: 24px;
        font-weight: 900;
        line-height: 1.3;
      }
      .result-details {
        font-size: 16px;
        color: var(--text-secondary);
        line-height: 1.5;
        margin-top: 16px;
        max-width: 320px;
      }
      .result-details p {
        margin-bottom: 1em;
      }
      .result-details p:last-child {
        margin-bottom: 0;
      }
      .result-footer {
        padding: 0 var(--padding-screen) 40px;
      }
      .done-btn {
        width: 100%;
        padding: 16px;
        background-color: #000;
        color: white;
        border: none;
        border-radius: 28px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transform: translateY(20px);
        font-family: var(--font-family);
      }
      [data-theme="dark"] .done-btn {
        background-color: var(--accent-green);
        color: #000000;
      }
      .status-menu-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 5000;
        display: none;
      }
      .status-menu {
        position: absolute;
        top: 60px;
        right: var(--padding-screen);
        background-color: var(--menu-bg);
        border-radius: 14px;
        border: 1px solid var(--menu-border);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        padding: 8px 0;
        min-width: 250px;
        opacity: 0;
        transform: scale(0.95);
        transform-origin: top right;
        transition: all 0.2s ease;
      }
      .status-menu.show {
        opacity: 1;
        transform: scale(1);
      }
      .status-menu-item {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 14px 20px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 1px solid var(--menu-divider);
        color: var(--text-primary);
      }
      .status-menu-item:last-child {
        border-bottom: none;
      }
      .status-menu-item:hover {
        background-color: var(--menu-hover);
      }
      .status-menu-item i {
        width: 20px;
        text-align: center;
        color: var(--text-secondary);
      }
    </style>
  </head>
  <body>
    <div class="result-container">
      <header class="result-header">
        <a href="pay.html">
          <svg
            class="close-btn"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24.0 24.0"
          >
            <path
              fill="currentColor"
              d="M19.823 2.055a0.25 0.25 0 0 1 0.354 0l1.767 1.768a0.25 0.25 0 0 1 0 0.354L14.121 12l7.823 7.823a0.25 0.25 0 0 1 0 0.354l-1.767 1.767a0.25 0.25 0 0 1-0.354 0L12 14.121l-7.823 7.823a0.25 0.25 0 0 1-0.354 0l-1.768-1.767a0.25 0.25 0 0 1 0-0.354L9.88 12 2.055 4.177a0.25 0.25 0 0 1 0-0.354l1.768-1.768a0.25 0.25 0 0 1 0.354 0L12 9.88l7.823-7.824z"
            />
          </svg>
        </a>
        <button class="menu-btn" id="menu-btn">
          <i class="fa-solid fa-ellipsis-vertical"></i>
        </button>
      </header>
      <main class="result-content" id="result-content"></main>
      <footer class="result-footer">
        <a href="pay.html"
          ><button class="done-btn" id="done-btn">Done</button></a
        >
      </footer>
      <div class="status-menu-overlay" id="status-menu-overlay">
        <div class="status-menu" id="status-menu">
          <div class="status-menu-item" data-status="pending">
            <i class="fa-solid fa-hourglass-half"></i
            ><span>Pending Verification</span>
          </div>
          <div class="status-menu-item" data-status="success">
            <i class="fa-solid fa-check"></i><span>Direct Success</span>
          </div>
          <div class="status-menu-item" data-status="received">
            <i class="fa-solid fa-arrow-down"></i><span>Standard Received</span>
          </div>
        </div>
      </div>
    </div>

    <script>
      const resultContent = document.getElementById("result-content");
      const doneBtn = document.getElementById("done-btn");
      const menuBtn = document.getElementById("menu-btn");
      const statusMenuOverlay = document.getElementById("status-menu-overlay");
      const statusMenu = document.getElementById("status-menu");

      const paymentAmountKey = "paymentAmount";
      const pendingRecipientDataKey = "pendingRecipientData";
      const pendingPaymentMessageKey = "pendingPaymentMessage";
      const balanceKey = "cashAppBalance";
      const transactionsKey = "cashAppTransactions";

      let tempTransaction = null;

      const statusTemplates = {
        success: (amount, contactName, note) => ({
          iconClass: "success",
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24.0 24.0"><path fill="currentColor" d="M22.757 5.65l-12 14a1 1 0 0 1-1.517 0l-6-7 1.517-1.3L10 17.462 21.239 4.35l1.518 1.3z"/></svg>',
          title: `You sent ${amount} to ${contactName}`,
          buttonText: "Done",
        }),
        // This is the NEW pending section with a thicker icon
        pending: (amount, cashtag) => ({
          iconClass: "pending",
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M18 6L6 18M6 6l12 12"/></svg>',
          title: `Payment couldn't be completed`,
          details: `<p>This payment is pending for security reasons. The ${amount} will be released to ${cashtag} when a $50 verification payment is sent.</p>`,
          buttonText: "OK",
        }),
        received: (amount, contactName) => ({
          iconClass: "received",
          icon: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24.0 24.0"><path fill="currentColor" d="M13 5.5v10.086l2.793-2.793 1.414 1.414-4.5 4.5a1 1 0 0 1-1.34 0.066l-0.074-0.066-4.5-4.5 1.414-1.414L11 15.586V5.5h2z"/></svg>',
          title: `${amount} received`,
          details: `<p>From ${contactName}</p>`,
          buttonText: "Done",
        }),
      };

      function formatCurrency(amount) {
        return `$${Number(amount).toLocaleString("en-US", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        })}`;
      }

      function renderResult(transaction) {
        const recipient = transaction.recipient;
        if (!recipient) {
          resultContent.innerHTML = `<h1 class="result-title">Error: Recipient data missing.</h1>`;
          return;
        }

        const template = statusTemplates[transaction.status](
          formatCurrency(transaction.amount),
          transaction.status === "pending" ? recipient.cashtag : recipient.name,
          transaction.note
        );

        resultContent.innerHTML = `<div class="status-icon ${
          template.iconClass
        }">${template.icon}</div><h1 class="result-title">${
          template.title
        }</h1>${
          template.details
            ? `<div class="result-details">${template.details}</div>`
            : ""
        }`;
        doneBtn.textContent = template.buttonText;
        const iconEl = resultContent.querySelector(".status-icon");
        iconEl.style.animation = "none";
        void iconEl.offsetWidth;
        iconEl.style.animation = "";
      }

      function updateTransactionStatus(newStatus) {
        if (!tempTransaction) return;
        tempTransaction.status = newStatus;
        renderResult(tempTransaction);
      }

      function finalizeTransaction() {
        if (!tempTransaction) return;

        let balance = parseFloat(localStorage.getItem(balanceKey) || "0");
        const transactions =
          JSON.parse(localStorage.getItem(transactionsKey)) || [];

        if (
          tempTransaction.type === "payment" &&
          (tempTransaction.status === "success" ||
            tempTransaction.status === "pending")
        ) {
          balance -= tempTransaction.amount;
        }

        transactions.push(tempTransaction);
        localStorage.setItem(balanceKey, balance.toString());
        localStorage.setItem(transactionsKey, JSON.stringify(transactions));

        localStorage.removeItem(paymentAmountKey);
        localStorage.removeItem(pendingRecipientDataKey);
        localStorage.removeItem(pendingPaymentMessageKey);

        window.dispatchEvent(new Event("storage"));
      }

      document.addEventListener("DOMContentLoaded", () => {
        const paymentAmount = parseFloat(
          localStorage.getItem(paymentAmountKey)
        );
        const recipientDataString = localStorage.getItem(
          pendingRecipientDataKey
        );
        const paymentMessage =
          localStorage.getItem(pendingPaymentMessageKey) || "";

        if (!paymentAmount || !recipientDataString) {
          window.location.href = "pay.html";
          return;
        }

        const recipient = JSON.parse(recipientDataString);

        tempTransaction = {
          id: Date.now(),
          type: "payment",
          amount: paymentAmount,
          recipient: recipient,
          note: paymentMessage,
          date: new Date().toISOString(),
          status: "success",
        };

        renderResult(tempTransaction);

        menuBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          statusMenuOverlay.style.display = "block";
          setTimeout(() => statusMenu.classList.add("show"), 10);
        });

        statusMenuOverlay.addEventListener("click", () => {
          statusMenu.classList.remove("show");
          setTimeout(() => (statusMenuOverlay.style.display = "none"), 200);
        });

        statusMenu.addEventListener("click", (e) => {
          const item = e.target.closest(".status-menu-item");
          if (item && item.dataset.status) {
            updateTransactionStatus(item.dataset.status);
          }
        });

        doneBtn.addEventListener("click", (e) => {
          e.preventDefault();
          finalizeTransaction();
          window.location.href = "pay.html";
        });
      });
    </script>
  </body>
</html>
