<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Profile - Cash App</title>
    <script src="guard.js"></script>

    <!-- Final Polished Styles -->
    <style>
      :root {
        --primary-text: #000000;
        --secondary-text: #6c6c6c;
        --background-main: #ffffff;
        --background-alt: #f0f1f2;
        --divider-color: #e5e5e5;
        --chevron-color: #8e8e93;
        --green-accent: #00d54b;
        --font-family: "CashMarket", -apple-system, BlinkMacSystemFont,
          sans-serif;
      }

      *,
      *::before,
      *::after {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      @font-face {
        font-family: "CashMarket";
        font-style: normal;
        src: url(font/CashSans-Regular.otf);
        font-display: swap;
      }

      html {
        scroll-behavior: smooth;
      }

      body {
        background-color: var(--background-main);
        font-family: var(--font-family);
        margin: 0;
        color: var(--primary-text);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        overflow-x: hidden;
      }
      body.modal-open {
        overflow: hidden;
      }
      a {
        text-decoration: none;
        color: inherit;
      }

      .header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 12px;
        background-color: var(--background-main);
        z-index: 1000;
      }
      .header-icons {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .header-icon-button {
        position: relative;
        overflow: hidden;
        background: none;
        border: none;
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s ease-in-out;
      }

      .page-content {
        padding-top: 60px;
        width: 100%;
        max-width: 680px;
        margin: 0 auto;
        padding-bottom: 40px;
      }

      .profile-info {
        padding: 10px 20px 40px;
      }
      .profile-picture-container {
        position: relative;
        display: inline-block;
        margin-bottom: 16px;
        cursor: pointer;
      }
      .profile-picture {
        width: 70px;
        height: 70px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        background-color: var(--background-alt); /* Placeholder color */
      }
      .camera-icon {
        position: absolute;
        bottom: 0;
        right: 0;
        width: 28px;
        height: 28px;
        background-color: #efefef;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .profile-name {
        font-size: 24px;
        font-weight: 700;
        margin: 0;
      }
      .cashtag {
        display: inline-flex;
        align-items: center;
        background-color: var(--background-alt);
        padding: 4px 10px;
        border-radius: 14px;
        margin-top: 8px;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
      }

      .list-item {
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        text-decoration: none;
        color: inherit;
        padding: 12px 20px;
        cursor: pointer;
        transition: background-color 0.2s ease-in-out;
      }

      .list-item-icon-bg {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 16px;
        flex-shrink: 0;
      }
      .list-item-icon-bg.gray {
        background-color: var(--background-alt);
      }
      .list-item-icon-bg.green {
        background-color: var(--green-accent);
      }
      .list-item-text-container {
        flex-grow: 1;
      }
      .list-item-title {
        font-size: 16px;
        font-weight: 600;
      }
      .list-item-subtitle {
        font-size: 13px;
        color: var(--secondary-text);
        margin-top: 2px;
      }

      .divider {
        height: 1px;
        background-color: var(--divider-color);
        margin: 16px 20px;
        border: none;
      }
      .settings-title {
        font-size: 20px;
        font-weight: 700;
        margin: 0 0 8px;
        padding: 0 20px;
      }
      .settings-item-text {
        flex-grow: 1;
        margin-left: 16px;
        font-size: 16px;
        font-weight: 600;
      }

      .personal-edit-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: white;
        z-index: 4000;
        transform: translateX(100%);
        transition: transform 0.35s ease-in-out;
        display: flex;
        flex-direction: column;
      }
      .personal-edit-overlay.show {
        transform: translateX(0);
      }
      .edit-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 12px;
        height: 60px;
        border-bottom: 1px solid var(--divider-color);
        flex-shrink: 0;
      }
      .edit-header-button {
        position: relative;
        overflow: hidden;
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px;
        border-radius: 8px;
        transition: background-color 0.2s ease-in-out;
      }
      .edit-back-btn {
        font-size: 20px;
      }
      .edit-title {
        font-size: 18px;
        font-weight: 600;
      }
      .edit-done-btn {
        font-size: 17px;
        color: var(--green-accent);
      }
      .edit-done-btn:disabled {
        color: #a0e6bb;
        cursor: not-allowed;
      }
      .edit-content {
        padding: 32px 20px;
        overflow-y: auto;
        flex-grow: 1;
        text-align: center;
      }
      .edit-profile-pic {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        display: block;
        margin: 0 auto 12px;
        background-color: var(--background-alt);
      }
      .change-photo-link {
        display: inline-block;
        color: var(--green-accent);
        font-weight: 600;
        font-size: 16px;
        cursor: pointer;
        margin-bottom: 40px;
      }
      #edit-pic-input {
        display: none;
      }
      .input-group {
        margin-bottom: 24px;
        text-align: left;
      }
      .input-group label {
        display: block;
        font-size: 13px;
        font-weight: 600;
        color: var(--secondary-text);
        margin-bottom: 8px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .input-group input {
        width: 100%;
        padding: 18px 16px;
        border: 1.5px solid var(--divider-color);
        border-radius: 8px;
        font-size: 16px;
        font-family: inherit;
        transition: border-color 0.2s, box-shadow 0.2s;
      }
      .input-group input:focus {
        border-color: var(--green-accent);
        outline: none;
        box-shadow: 0 0 0 3px rgba(0, 213, 75, 0.2);
      }

      .icon-img {
        display: block;
      }
      .icon-img-lg {
        width: 20px;
        height: 20px;
      }
      .icon-img-md {
        width: 22px;
        height: 22px;
      }
      .icon-img-sm {
        width: 24px;
        height: 24px;
      }
      .icon-img-xs {
        width: 25px;
        height: 25px;
      }
      .icon-camera-img {
        width: 16px;
        height: 16px;
      }

      .cashtag-chevron,
      .chevron {
        stroke: var(--chevron-color);
      }

      /* New Footer Styles */
      .page-footer {
        text-align: center;
        padding: 24px 28px 0;
      }
      .footer-shield-icon {
        width: 32px;
        height: 32px;
        margin: 0 auto 16px;
        display: block;
      }
      .footer-text {
        font-size: 13px;
        line-height: 1.5;
        color: var(--secondary-text);
        margin: 0 0 24px;
      }
      .footer-text a {
        color: var(--primary-text);
        text-decoration: underline;
      }
      .footer-social-links {
        display: flex;
        justify-content: center;
        gap: 24px;
        margin-bottom: 24px;
      }
      .footer-social-icon {
        width: 24px;
        height: 24px;
      }
      .footer-version {
        font-size: 13px;
        color: var(--secondary-text);
      }
    </style>
  </head>
  <body>
    <header class="header">
      <a href="home.html" class="header-icon-button" aria-label="Close">
        <img
          src="icon/new_close_Normal_monochrome-black (1).png"
          alt="Close"
          class="icon-img-lg"
        />
      </a>
      <div class="header-icons">
        <button class="header-icon-button" aria-label="QR Code">
          <img
            src="icon/navigationScanQr_Normal_Normal@2x_1_monochrome-black (1).png"
            alt="QR Code"
            class="icon-img-md"
          />
        </button>
        <button class="header-icon-button" aria-label="Upload">
          <img
            src="icon/navigationShareIos_Normal_Normal@2x_monochrome-black (1).png"
            alt="Upload"
            class="icon-img-md"
          />
        </button>
      </div>
    </header>

    <div class="page-content">
      <section class="profile-info">
        <div
          class="profile-picture-container"
          id="main-profile-picture-container"
        >
          <img
            src=""
            alt="Profile Picture"
            class="profile-picture"
            id="main-profile-pic"
          />
          <div class="camera-icon">
            <img
              src="icon/cameraFill24_Normal_Normal@3x_monochrome-black.png"
              alt="Change Photo"
              class="icon-camera-img"
            />
          </div>
        </div>
        <h1 class="profile-name" id="main-profile-name"></h1>
        <div class="cashtag" id="main-cashtag-container">
          <span id="main-cashtag"></span>
          <svg
            class="cashtag-chevron"
            width="16"
            height="16"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
            style="margin-left: 4px"
          >
            <polyline points="6 9 12 15 18 9"></polyline>
          </svg>
        </div>
      </section>

      <!-- ACTION LINKS -->
      <a href="#" class="list-item" id="personal-btn">
        <div class="list-item-icon-bg gray">
          <img
            src="icon/edit24_Normal_Normal@3x_custom-tint.png"
            alt=""
            class="icon-img-xs"
          />
        </div>
        <div class="list-item-text-container">
          <div class="list-item-title">Edit profile</div>
          <div class="list-item-subtitle">Update your profile info</div>
        </div>
        <svg
          class="chevron"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"
          stroke-linejoin="round"
          style="width: 20px; height: 20px"
        >
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>
      <a href="#" class="list-item">
        <div class="list-item-icon-bg green">
          <img
            src="icon/add32_Normal_Normal@3x_monochrome-black.png"
            alt=""
            class="icon-img-xs"
            style="filter: brightness(0) invert(1)"
          />
        </div>
        <div class="list-item-text-container">
          <div class="list-item-title">Invite friends</div>
          <div class="list-item-subtitle">Get $15</div>
        </div>
        <svg
          class="chevron"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="3"
          stroke-linecap="round"
          stroke-linejoin="round"
          style="width: 20px; height: 20px"
        >
          <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
      </a>

      <hr class="divider" />

      <main>
        <h2 class="settings-title">Account & settings</h2>
        <nav>
          <a href="#" class="list-item">
            <img src="icon/person_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Personal</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img src="icon/bank_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Linked banks</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img src="icon/link_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Linked apps & businesses</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img src="icon/shield_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Security & privacy</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img src="icon/star_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Favorites</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img src="icon/limit_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Limits</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img
              src="icon/notification_Normal.png"
              alt=""
              class="icon-img-sm"
            />
            <span class="settings-item-text">Notifications</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <!-- START OF NEW CONTENT -->
          <a href="dark-mode.html" class="list-item">
            <img src="icon/theme_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Themes</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="#" class="list-item">
            <img
              src="icon/document24_Normal_Normal@3x_monochrome-black.png"
              alt=""
              class="icon-img-sm"
            />
            <span class="settings-item-text">Documents</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <a href="support.html" class="list-item">
            <img src="icon/help_Normal.png" alt="" class="icon-img-sm" />
            <span class="settings-item-text">Support</span>
            <svg
              class="chevron"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="3"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="width: 20px; height: 20px"
            >
              <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
          </a>
          <!-- END OF NEW CONTENT -->
        </nav>
      </main>

      <!-- START OF NEW FOOTER -->
      <footer class="page-footer">
        <img
          src="icon/fdic32_Normal_Normal@3x_1_custom-tint.png"
          alt="Security Shield"
          class="footer-shield-icon"
        />
        <p class="footer-text">
          Your balance is eligible for FDIC pass-through insurance through our
          Program Banks Wells Fargo Bank, N.A. and/or Sutton Bank, Members FDIC
          for up to $250,000 per customer when aggregated with all other
          deposits held in the same legal capacity at each Program Bank above,
          if certain conditions are met.
        </p>
        <p class="footer-text">
          Cash App is a financial services platform, and not an FDIC-insured
          bank. Prepaid debit cards issued by Sutton Bank, Member FDIC.
          <a href="#">See terms and conditions.</a>
        </p>
        <p class="footer-text">
          Cash App's <a href="#">Privacy Notice</a>,
          <a href="#">Terms of Service</a> and
          <a href="#">Open Source Software</a>
        </p>
        <div class="footer-social-links">
          <a href="#">
            <img
              src="icon/instagram-2_Normal.png"
              alt="Instagram"
              class="footer-social-icon"
            />
          </a>
          <a href="#">
            <img src="icon/x_Normal.png" alt="X" class="footer-social-icon" />
          </a>
        </div>
        <p class="footer-version">Version 2.86 (2860041)</p>
      </footer>
      <!-- END OF NEW FOOTER -->
    </div>

    <div class="personal-edit-overlay" id="personal-edit-overlay">
      <header class="edit-header">
        <button
          class="edit-header-button edit-back-btn"
          id="edit-back-btn"
          aria-label="Back"
        >
          <img
            src="icon/backArrow_Normal_monochrome-black.png"
            alt="Back"
            class="icon-img-md"
          />
        </button>
        <h2 class="edit-title">Personal</h2>
        <button
          class="edit-header-button edit-done-btn"
          id="edit-done-btn"
          disabled
        >
          Done
        </button>
      </header>
      <main class="edit-content">
        <img
          src=""
          alt="Edit Profile Picture"
          class="edit-profile-pic"
          id="edit-profile-pic"
        />
        <span class="change-photo-link">Change Photo</span>
        <input type="file" id="edit-pic-input" accept="image/*" />
        <div class="input-group">
          <label for="edit-full-name">Full Name</label>
          <input type="text" id="edit-full-name" />
        </div>
        <div class="input-group">
          <label for="edit-cashtag">$Cashtag</label>
          <input type="text" id="edit-cashtag" />
        </div>
        <div class="input-group">
          <label for="edit-account-number">Account Number</label>
          <input type="text" id="edit-account-number" />
        </div>
        <div class="input-group">
          <label for="edit-routing-number">Routing Number</label>
          <input type="text" id="edit-routing-number" />
        </div>
      </main>
    </div>

    <!-- SCRIPTS -->
    <script>
      // FINAL, CORRECTED AND RESTORED SCRIPT
      const profilePageKey = "cashAppProfilePageData"; // Dedicated key for this page's complete state
      const globalProfileKey = "cashAppUserProfile"; // For sharing data with ALL other pages

      let userProfile = {}; // This object holds the complete state for this page

      // DOM Elements
      const mainProfilePic = document.getElementById("main-profile-pic");
      const mainProfileName = document.getElementById("main-profile-name");
      const mainCashtag = document.getElementById("main-cashtag");
      const personalBtn = document.getElementById("personal-btn");
      const personalEditOverlay = document.getElementById(
        "personal-edit-overlay"
      );
      const editBackBtn = document.getElementById("edit-back-btn");
      const editDoneBtn = document.getElementById("edit-done-btn");
      const editProfilePic = document.getElementById("edit-profile-pic");
      const editPicInput = document.getElementById("edit-pic-input");
      const editFullName = document.getElementById("edit-full-name");
      const editCashtag = document.getElementById("edit-cashtag");
      const editAccountNumber = document.getElementById("edit-account-number");
      const editRoutingNumber = document.getElementById("edit-routing-number");
      const changePhotoLink = document.querySelector(".change-photo-link");
      const mainProfilePicContainer = document.getElementById(
        "main-profile-picture-container"
      );
      const mainCashtagContainer = document.getElementById(
        "main-cashtag-container"
      );

      // --- GENERATE PERFECTLY ALIGNED INITIALS AVATAR ---
      function generateInitialAvatar(name) {
        const canvas = document.createElement("canvas");
        const context = canvas.getContext("2d");
        const size = 200;
        canvas.width = size;
        canvas.height = size;
        const colors = [
          "#00d54b",
          "#1a73e8",
          "#f44336",
          "#ff9800",
          "#9c27b0",
          "#673ab7",
        ];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        context.fillStyle = randomColor;
        context.fillRect(0, 0, size, size);
        const nameParts = name.trim().split(" ");
        const initials = (
          nameParts.length > 1
            ? nameParts[0][0] + nameParts[nameParts.length - 1][0]
            : nameParts[0]?.[0] || ""
        ).toUpperCase();
        context.fillStyle = "#ffffff";
        context.font = `bold ${
          size / 2
        }px "CashMarket", -apple-system, BlinkMacSystemFont, sans-serif`;
        context.textAlign = "center";
        context.textBaseline = "middle";
        context.fillText(initials, size / 2, size / 2 + size * 0.05);
        return canvas.toDataURL();
      }

      // --- FETCH RANDOM USER FROM API ---
      async function createDefaultProfile() {
        let fullName = "Alex Morgan";
        let cashtag = "alexmorgan";
        try {
          const response = await fetch(
            "https://randomuser.me/api/?nat=us,gb,ca"
          );
          if (!response.ok) throw new Error("API fetch failed");
          const data = await response.json();
          const user = data.results[0];
          fullName = `${user.name.first} ${user.name.last}`;
          cashtag = `${user.login.username}`;
        } catch (error) {
          console.error("Could not fetch random user, using fallback.", error);
        }
        const initialAvatar = generateInitialAvatar(fullName);
        return {
          fullName: fullName,
          cashtag: cashtag,
          accountNumber: "••••" + Math.floor(1000 + Math.random() * 9000),
          routingNumber: "••••" + Math.floor(1000 + Math.random() * 9000),
          profilePic: initialAvatar, // The initial is stored here for the profile page
          hasUploadedPhoto: false,
        };
      }

      // --- CORE LOGIC (FIXED AND RESTORED) ---
      function saveProfile() {
        // Step 1: Always save the complete data for THIS page.
        localStorage.setItem(profilePageKey, JSON.stringify(userProfile));

        // Step 2: Create and save the shared data for OTHER pages.
        const globalProfileData = {
          fullName: userProfile.fullName,
          accountNumber: userProfile.accountNumber, // Restored
          routingNumber: userProfile.routingNumber, // Restored
          // CRITICAL: Only share the photo if it's a real uploaded one.
          // Otherwise, share 'null' so other pages show their default icon.
          profilePic: userProfile.hasUploadedPhoto
            ? userProfile.profilePic
            : null,
        };
        localStorage.setItem(
          globalProfileKey,
          JSON.stringify(globalProfileData)
        );
      }

      async function loadProfile() {
        const savedProfile = localStorage.getItem(profilePageKey);
        if (savedProfile) {
          userProfile = JSON.parse(savedProfile);
        } else {
          userProfile = await createDefaultProfile();
          saveProfile(); // Save both the page and global profiles for the first time
        }
        updateMainUI();
      }

      function updateMainUI() {
        mainProfileName.textContent = userProfile.fullName;
        mainCashtag.textContent = `$${userProfile.cashtag}`;
        mainProfilePic.src = userProfile.profilePic;
        editProfilePic.src = userProfile.profilePic;
      }

      function openEditOverlay() {
        editFullName.value = userProfile.fullName;
        editCashtag.value = userProfile.cashtag;
        editAccountNumber.value = userProfile.accountNumber;
        editRoutingNumber.value = userProfile.routingNumber;
        editProfilePic.src = userProfile.profilePic;
        editDoneBtn.disabled = true;
        personalEditOverlay.classList.add("show");
        document.body.classList.add("modal-open");
      }

      function closeEditOverlay() {
        personalEditOverlay.classList.remove("show");
        document.body.classList.remove("modal-open");
      }

      function handleSaveChanges() {
        // Update the state object with the new values from the form
        userProfile.fullName = editFullName.value;
        userProfile.cashtag = editCashtag.value;
        userProfile.accountNumber = editAccountNumber.value;
        userProfile.routingNumber = editRoutingNumber.value;

        // If the name changed but they still don't have a real photo,
        // we must regenerate the initial to match the new name.
        if (!userProfile.hasUploadedPhoto) {
          userProfile.profilePic = generateInitialAvatar(userProfile.fullName);
        }

        saveProfile(); // Save the updated data to both local storage keys
        updateMainUI(); // Refresh the main UI to show the changes
        closeEditOverlay();
      }

      // --- EVENT LISTENERS ---
      personalBtn.addEventListener("click", (e) => {
        e.preventDefault();
        openEditOverlay();
      });
      mainProfilePicContainer.addEventListener("click", (e) => {
        e.preventDefault();
        openEditOverlay();
      });
      mainCashtagContainer.addEventListener("click", (e) => {
        e.preventDefault();
        openEditOverlay();
      });
      editBackBtn.addEventListener("click", closeEditOverlay);
      editDoneBtn.addEventListener("click", handleSaveChanges);

      [editFullName, editCashtag, editAccountNumber, editRoutingNumber].forEach(
        (input) =>
          input.addEventListener("input", () => {
            editDoneBtn.disabled = false;
          })
      );

      // Real-time initial update when editing the name
      editFullName.addEventListener("input", () => {
        if (!userProfile.hasUploadedPhoto) {
          const newInitial = generateInitialAvatar(editFullName.value);
          editProfilePic.src = newInitial;
        }
      });

      changePhotoLink.addEventListener("click", () => editPicInput.click());

      // Handle file upload
      editPicInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          const newPicSrc = e.target.result;
          userProfile.profilePic = newPicSrc; // This is now a real photo URL
          userProfile.hasUploadedPhoto = true; // Set the flag to true!
          editProfilePic.src = newPicSrc;
          editDoneBtn.disabled = false;
        };
        reader.readAsDataURL(file);
      });

      // Initialize the profile when the page loads
      document.addEventListener("DOMContentLoaded", loadProfile);
    </script>
  </body>
</html>
