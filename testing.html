<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ultra Advanced Lottie Viewer</title>

    <!-- Lottie-Web Player from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>

    <style>
      /* --- 1. Global Styles & Theming --- */
      :root {
        --bg-color: #1a1a1d;
        --panel-color: #2c2c34;
        --text-color: #e1e1e6;
        --primary-color: #4a90e2;
        --primary-hover-color: #63a4ff;
        --border-color: #40404a;
        --input-bg: #101012;
        --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji";
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        height: 100%;
        overflow: hidden;
        font-family: var(--font-family);
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 14px;
      }

      /* --- 2. Main Layout --- */
      .app-container {
        display: flex;
        height: 100vh;
      }

      .viewer-main {
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .controls-sidebar {
        width: 320px;
        flex-shrink: 0;
        background-color: var(--panel-color);
        border-left: 1px solid var(--border-color);
        padding: 20px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      /* --- 3. Viewer Area & Dropzone --- */
      #lottie-container {
        flex-grow: 1;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s ease;
      }

      #lottie-canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      .dropzone-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(74, 144, 226, 0.2);
        border: 3px dashed var(--primary-color);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 24px;
        font-weight: 600;
        color: var(--primary-color);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.2s ease-in-out;
        z-index: 10;
      }

      #lottie-container.drag-over .dropzone-overlay {
        opacity: 1;
      }

      .placeholder-text {
        text-align: center;
        max-width: 400px;
        color: #777;
        font-size: 1.2em;
        line-height: 1.6;
      }
      .placeholder-text h2 {
        color: var(--text-color);
        margin-bottom: 10px;
      }

      /* --- 4. Sidebar Controls Styling --- */
      .control-group {
        margin-bottom: 25px;
      }

      .control-group h3 {
        font-size: 1em;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #999;
        margin-bottom: 12px;
        padding-bottom: 5px;
        border-bottom: 1px solid var(--border-color);
      }

      /* Input & Buttons */
      .input-group {
        display: flex;
        margin-bottom: 10px;
      }
      .url-input {
        flex-grow: 1;
        padding: 10px;
        background-color: var(--input-bg);
        border: 1px solid var(--border-color);
        border-right: none;
        color: var(--text-color);
        border-radius: 4px 0 0 4px;
        outline: none;
        transition: border-color 0.2s ease;
      }
      .url-input:focus {
        border-color: var(--primary-color);
      }

      .btn {
        padding: 10px 15px;
        border: none;
        background-color: var(--primary-color);
        color: white;
        cursor: pointer;
        font-weight: 600;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .btn:hover {
        background-color: var(--primary-hover-color);
      }
      .btn.load-btn {
        border-radius: 0 4px 4px 0;
      }
      .btn.file-btn {
        width: 100%;
        border-radius: 4px;
      }

      .file-input {
        display: none;
      }

      .playback-controls {
        display: grid;
        grid-template-columns: repeat(
          3,
          1fr
        ); /* MODIFIED: Changed from 2 to 3 columns for loop button */
        gap: 10px;
        margin-bottom: 15px;
      }

      .playback-controls .btn {
        border-radius: 4px;
        height: 40px;
      }

      .playback-controls .btn svg {
        width: 20px;
        height: 20px;
        fill: white;
      }

      /* Sliders */
      .slider-group {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
      }
      .slider-group label {
        flex-basis: 70px;
        flex-shrink: 0;
        font-size: 0.9em;
      }
      .slider {
        -webkit-appearance: none;
        width: 100%;
        height: 6px;
        background: var(--input-bg);
        outline: none;
        border-radius: 3px;
        cursor: pointer;
      }
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        background: var(--primary-color);
        cursor: pointer;
        border-radius: 50%;
        transition: background-color 0.2s ease;
      }
      .slider::-moz-range-thumb {
        width: 16px;
        height: 16px;
        background: var(--primary-color);
        cursor: pointer;
        border-radius: 50%;
        border: none;
        transition: background-color 0.2s ease;
      }

      .slider-group span {
        margin-left: 10px;
        min-width: 40px;
        text-align: right;
        font-family: "SF Mono", "Fira Code", monospace;
      }

      /* Toggle & Color Picker */
      .misc-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .toggle-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .color-picker {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 40px;
        height: 40px;
        background-color: transparent;
        border: none;
        cursor: pointer;
      }
      .color-picker::-webkit-color-swatch-wrapper {
        padding: 0;
      }
      .color-picker::-webkit-color-swatch {
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }
      .color-picker::-moz-color-swatch {
        border: 1px solid var(--border-color);
        border-radius: 4px;
      }

      /* Information Panel */
      #info-panel {
        font-family: "SF Mono", "Fira Code", monospace;
        font-size: 0.9em;
        line-height: 1.8;
      }
      #info-panel div {
        display: flex;
        justify-content: space-between;
      }
      #info-panel span:first-child {
        color: #999;
      }

      /* Utility Classes */
      #controls-wrapper.disabled {
        opacity: 0.4;
        pointer-events: none;
      }

      /* --- 5. Responsive Design --- */
      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }
        .controls-sidebar {
          width: 100%;
          height: 45vh;
          max-height: 50vh;
          border-left: none;
          border-top: 1px solid var(--border-color);
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Main Viewer and Drop Zone -->
      <main class="viewer-main">
        <div id="lottie-container">
          <div id="lottie-canvas"></div>
          <div class="dropzone-overlay">Drop .json file</div>
          <div class="placeholder-text" id="placeholder">
            <h2>Advanced Lottie Viewer</h2>
            <p>
              Drag & drop a Lottie <strong>.json</strong> file anywhere, or use
              the controls on the right to load an animation.
            </p>
          </div>
        </div>
      </main>

      <!-- Sidebar with All Controls -->
      <aside class="controls-sidebar">
        <div class="control-group">
          <h3>Load Animation</h3>
          <div class="input-group">
            <input
              type="text"
              id="url-input"
              class="url-input"
              placeholder="Enter Lottie JSON URL..."
            />
            <button id="load-url-btn" class="btn load-btn">Load</button>
          </div>
          <button id="load-file-btn" class="btn file-btn">
            Load From File
          </button>
          <input
            type="file"
            id="file-input"
            class="file-input"
            accept=".json"
          />
        </div>

        <div id="controls-wrapper" class="disabled">
          <div class="control-group">
            <h3>Playback</h3>
            <div class="playback-controls">
              <button id="play-pause-btn" class="btn">
                <!-- Play SVG Icon -->
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
              </button>
              <button id="stop-btn" class="btn">
                <!-- Stop SVG Icon -->
                <svg viewBox="0 0 24 24"><path d="M6 6h12v12H6z"></path></svg>
              </button>
              <!-- NEW: Loop Button -->
              <button id="loop-btn" class="btn">
                <!-- Loop SVG Icon -->
                <svg viewBox="0 0 24 24">
                  <path
                    d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"
                  ></path>
                </svg>
              </button>
            </div>

            <div class="slider-group">
              <label for="progress-slider">Frame</label>
              <input
                type="range"
                id="progress-slider"
                class="slider"
                min="0"
                max="100"
                value="0"
              />
              <span id="frame-counter">0 / 0</span>
            </div>
          </div>

          <div class="control-group">
            <h3>Settings</h3>
            <div class="slider-group">
              <label for="speed-slider">Speed</label>
              <input
                type="range"
                id="speed-slider"
                class="slider"
                min="0.25"
                max="3"
                step="0.25"
                value="1"
              />
              <span id="speed-indicator">1.00x</span>
            </div>
            <div class="misc-controls">
              <div class="toggle-group">
                <label for="bg-color-picker">BG Color</label>
                <input
                  type="color"
                  id="bg-color-picker"
                  class="color-picker"
                  value="#1a1a1d"
                />
              </div>
            </div>
          </div>

          <div class="control-group">
            <h3>Information</h3>
            <div id="info-panel">
              <div>
                <span>Dimensions:</span><span id="info-dimensions">-</span>
              </div>
              <div>
                <span>Frame Rate:</span><span id="info-framerate">-</span>
              </div>
              <div>
                <span>Total Frames:</span><span id="info-totalframes">-</span>
              </div>
              <div><span>Duration:</span><span id="info-duration">-</span></div>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // --- 1. DOM Element References ---
        const lottieContainer = document.getElementById("lottie-container");
        const lottieCanvas = document.getElementById("lottie-canvas");
        const controlsWrapper = document.getElementById("controls-wrapper");
        const placeholder = document.getElementById("placeholder");

        // Load controls
        const urlInput = document.getElementById("url-input");
        const loadUrlBtn = document.getElementById("load-url-btn");
        const loadFileBtn = document.getElementById("load-file-btn");
        const fileInput = document.getElementById("file-input");

        // Playback controls
        const playPauseBtn = document.getElementById("play-pause-btn");
        const stopBtn = document.getElementById("stop-btn");
        const loopBtn = document.getElementById("loop-btn"); // NEW
        const progressSlider = document.getElementById("progress-slider");

        // Settings controls
        const speedSlider = document.getElementById("speed-slider");
        const bgColorPicker = document.getElementById("bg-color-picker");

        // Indicators & Info
        const frameCounter = document.getElementById("frame-counter");
        const speedIndicator = document.getElementById("speed-indicator");
        const infoDimensions = document.getElementById("info-dimensions");
        const infoFramerate = document.getElementById("info-framerate");
        const infoTotalFrames = document.getElementById("info-totalframes");
        const infoDuration = document.getElementById("info-duration");

        // SVG Icons
        const playIcon =
          '<svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>';
        const pauseIcon =
          '<svg viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>';

        // --- 2. State Management ---
        let anim = null;
        let isPlaying = false;
        let isLooping = false; // NEW

        // --- 3. Core Lottie Loading Function ---
        const loadAnimation = (animationData) => {
          if (anim) {
            anim.destroy();
            anim = null;
          }

          // Reset UI
          lottieCanvas.innerHTML = "";
          placeholder.style.display = "none";
          controlsWrapper.classList.remove("disabled");
          resetControls();

          try {
            const animParams = {
              container: lottieCanvas,
              renderer: "svg",
              loop: isLooping, // MODIFIED: respects the loop state
              autoplay: true,
              ...animationData,
            };

            anim = lottie.loadAnimation(animParams);

            // --- 4. Lottie Event Listeners ---
            anim.addEventListener("DOMLoaded", () => {
              updateInfoPanel();
              progressSlider.max = anim.totalFrames - 1;
              playPauseBtn.innerHTML = pauseIcon;
              isPlaying = true;
            });

            anim.addEventListener("enterFrame", () => {
              progressSlider.value = Math.floor(anim.currentFrame);
              updateFrameCounter();
            });

            anim.addEventListener("complete", () => {
              // MODIFIED: Only stop if not looping
              if (!isLooping) {
                playPauseBtn.innerHTML = playIcon;
                isPlaying = false;
              }
            });

            anim.addEventListener("data_failed", () => {
              handleLoadError("Lottie data failed to load.");
            });

            anim.addEventListener("error", (e) => {
              handleLoadError("An error occurred in the Lottie player.");
              console.error("Lottie error:", e);
            });
          } catch (error) {
            handleLoadError("Invalid JSON file.");
            console.error(error);
          }
        };

        const handleLoadError = (message) => {
          placeholder.style.display = "flex";
          placeholder.innerHTML = `<h2 style="color: #e25c5c;">Error</h2><p>${message}</p>`;
          controlsWrapper.classList.add("disabled");
          if (anim) anim.destroy();
        };

        // --- 5. UI Control Event Handlers ---

        // Loaders
        loadUrlBtn.addEventListener("click", () => {
          const url = urlInput.value.trim();
          if (url) {
            loadAnimation({ path: url });
          }
        });

        urlInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") loadUrlBtn.click();
        });

        loadFileBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", (e) => {
          const file = e.target.files[0];
          if (!file) return;

          const reader = new FileReader();
          reader.onload = (event) => {
            try {
              const jsonData = JSON.parse(event.target.result);
              loadAnimation({ animationData: jsonData });
            } catch (err) {
              handleLoadError("Could not parse the JSON file.");
              console.error(err);
            }
          };
          reader.readAsText(file);
          fileInput.value = ""; // Reset for same-file re-upload
        });

        // Drag & Drop
        lottieContainer.addEventListener("dragover", (e) => {
          e.preventDefault();
          lottieContainer.classList.add("drag-over");
        });
        lottieContainer.addEventListener("dragleave", () => {
          lottieContainer.classList.remove("drag-over");
        });
        lottieContainer.addEventListener("drop", (e) => {
          e.preventDefault();
          lottieContainer.classList.remove("drag-over");
          const file = e.dataTransfer.files[0];
          if (file && file.type === "application/json") {
            fileInput.files = e.dataTransfer.files;
            const changeEvent = new Event("change");
            fileInput.dispatchEvent(changeEvent);
          } else {
            handleLoadError("Please drop a valid .json file.");
          }
        });

        // Playback
        playPauseBtn.addEventListener("click", () => {
          if (!anim) return;
          if (isPlaying) {
            anim.pause();
            playPauseBtn.innerHTML = playIcon;
          } else {
            anim.play();
            playPauseBtn.innerHTML = pauseIcon;
          }
          isPlaying = !isPlaying;
        });

        stopBtn.addEventListener("click", () => {
          if (!anim) return;
          anim.stop();
          playPauseBtn.innerHTML = playIcon;
          isPlaying = false;
        });

        // NEW: Loop button event listener
        loopBtn.addEventListener("click", () => {
          if (!anim) return;
          isLooping = !isLooping;
          anim.setLoop(isLooping);
          // Provide visual feedback by changing the button color
          loopBtn.style.backgroundColor = isLooping
            ? "var(--primary-hover-color)"
            : "var(--primary-color)";
        });

        progressSlider.addEventListener("input", () => {
          if (!anim) return;
          anim.goToAndStop(progressSlider.value, true);
          updateFrameCounter();
          isPlaying = false;
          playPauseBtn.innerHTML = playIcon;
        });

        // Settings
        speedSlider.addEventListener("input", () => {
          if (!anim) return;
          anim.setSpeed(speedSlider.value);
          speedIndicator.textContent = `${parseFloat(speedSlider.value).toFixed(
            2
          )}x`;
        });

        bgColorPicker.addEventListener("input", () => {
          lottieContainer.style.backgroundColor = bgColorPicker.value;
        });

        // --- 6. Helper Functions ---
        const updateInfoPanel = () => {
          if (!anim) return;
          const { w, h } = anim.animationData;
          infoDimensions.textContent = `${w} x ${h} px`;
          infoFramerate.textContent = `${Math.round(anim.frameRate)} FPS`;
          infoTotalFrames.textContent = anim.totalFrames;
          const duration = anim.totalFrames / anim.frameRate;
          infoDuration.textContent = `${duration.toFixed(2)}s`;
        };

        const updateFrameCounter = () => {
          if (!anim) return;
          frameCounter.textContent = `${Math.floor(anim.currentFrame)} / ${
            anim.totalFrames - 1
          }`;
        };

        const resetControls = () => {
          progressSlider.value = 0;
          speedSlider.value = 1;
          speedIndicator.textContent = "1.00x";
          isLooping = false; // MODIFIED: Reset loop state
          loopBtn.style.backgroundColor = "var(--primary-color)"; // MODIFIED: Reset loop button color
          isPlaying = true;
        };
      });
    </script>
  </body>
</html>
